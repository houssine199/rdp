name: Windows-Miner-Max

on:
  workflow_dispatch:

jobs:
  miner:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 Ø³Ø§Ø¹Ø§Øª

    steps:
      - name: Download SRBMiner 3.0.3
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.3/SRBMiner-Multi-3-0-3-win64.zip" -OutFile "miner.zip"
          Expand-Archive miner.zip -DestinationPath "miner"

      - name: Start SRBMiner (yespoweradvc) Max CPU
        shell: pwsh
        run: |
          function Start-Miner {
            cd miner
            $folder = Get-ChildItem -Directory | Where-Object { $_.Name -like "SRBMiner*" } | Select-Object -First 1
            $exe = Join-Path $folder.FullName "SRBMiner-MULTI.exe"
            if (-not (Test-Path $exe)) { Write-Error "âŒ SRBMiner-MULTI.exe ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"; exit 1 }

            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©
            $cpuThreads = [Environment]::ProcessorCount
            Write-Host "â¡ ØªØ´ØºÙŠÙ„ SRBMiner Ø¨Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ù†ÙˆÙŠØ©: $cpuThreads"

            Start-Process $exe -ArgumentList @(
              "-a", "yespoweradvc",
              "-o", "stratum+tcps://eu.rplant.xyz:17149",
              "-u", "Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E",
              "-p", "x",
              "--cpu-threads", "$cpuThreads"
            )
          }

          # ØªØ´ØºÙŠÙ„ miner Ø£ÙˆÙ„ Ù…Ø±Ø©
          Start-Miner

      - name: Full Restart Before Timeout
        shell: pwsh
        run: |
          # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø³Ø§Ø¹Ø§Øª Ùˆ40 Ø¯Ù‚ÙŠÙ‚Ø© = 340 Ø¯Ù‚ÙŠÙ‚Ø©
          $waitMinutes = 340
          Write-Host "â± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± $waitMinutes Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ù„miner"
          Start-Sleep -Seconds ($waitMinutes * 60)

          # Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ miner ÙŠØ¹Ù…Ù„
          $procs = Get-Process -Name "SRBMiner-MULTI" -ErrorAction SilentlyContinue
          if ($procs) {
            Write-Host "â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„miner..."
            $procs | ForEach-Object { $_.Kill() }
            Start-Sleep -Seconds 5
          }

          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ miner ÙƒØ§Ù…Ù„ Ø¨Ø£Ù‚ØµÙ‰ Ù‚Ø¯Ø±Ø©
          Write-Host "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SRBMiner Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø£Ù‚ØµÙ‰ Ù‚Ø¯Ø±Ø§ØªÙ‡"
          cd miner
          $folder = Get-ChildItem -Directory | Where-Object { $_.Name -like "SRBMiner*" } | Select-Object -First 1
          $exe = Join-Path $folder.FullName "SRBMiner-MULTI.exe"
          $cpuThreads = [Environment]::ProcessorCount
          Start-Process $exe -ArgumentList @(
            "-a", "yespoweradvc",
            "-o", "stratum+tcps://eu.rplant.xyz:17149",
            "-u", "Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E",
            "-p", "x",
            "--cpu-threads", "$cpuThreads"
          )

          # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© workflow (~20 Ø¯Ù‚ÙŠÙ‚Ø©)
          $remainingMinutes = 20
          Write-Host "â± Ø§Ù†ØªØ¸Ø§Ø± $remainingMinutes Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© workflow"
          Start-Sleep -Seconds ($remainingMinutes * 60)

          Write-Host "âœ… Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© workflow"
